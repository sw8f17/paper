%%OLD% \chapter{Synchronization}
%%OLD% % Why are we writing about this?
%%OLD% A central element in this project is the ability to synchronize. 
%%OLD% This chapter aims to explore and evaluate different methods which could be used to synchronize several Android devices. 
%%OLD% % What requirements does this stem from?
%%OLD% Several of our requirements are directly related to synchronization, these are \tnote{ins√¶t dem her \ldots}.
%%OLD% % What are some of the issues regarding synchronization?
%%OLD% 
%%OLD% Synchronizing multiple devices is a hard problem, as there is a large amount of hardware and software between each of the devices in form of operating systems, driver, wireless chips, and various layers %%OLD% of abstraction, which all introduce either latency, either predictable or not. 
%%OLD% %Furthermore, even if the devices are synchronized, then the delay from a command is issued by our app, to the time the audio playback start  
%%OLD% Furthermore, there is a delay from when the command to play sound in software is issued, to when the actual playback occurs, which depends on the hard- and software of the smartphone. 
%%OLD% That is, that the delay might differ from smartphone to smartphone to such a degree that we need to take it into account. 
%%OLD% 
%%OLD% % What ways of sync do we imagine that exists?
%%OLD% 
%%OLD% We have identified four categories of methods to synchronize the devices:
%%OLD% \begin{itemize}
%%OLD%    \item Using a network connection,
%%OLD%    \item Using the GPS,
%%OLD%    \item Using the audio system of the devices,
%%OLD%    \item Using light, i.e. camera, screen and/or LED.
%%OLD% \end{itemize}
%%OLD% % http://ieeexplore.ieee.org/document/1424575/?arnumber=1424575&tag=1
%%OLD% 
%%OLD% % What way is "best"?
%%OLD% % How will we do it? 
\chapter{Synchronization}
%What is the importance of synchronization to us
    %hope for the best is not feasable
    %To make psychoacoustic effects reality we need farily accurate manipulation depending on effect
    %Audible sync is not the same as clock synchronization, a slight desync in clocks may actually cause psychoacoustic effects (precedence effect), essentially providing us with an acceptable threshold for desynchronization.
Simply sending playback commands between devices and hoping they are received fast enough to not disrupt the audible synchronization, is not a reliable solution and as such synchronization is important to the application.\mnote{What a sentence}
In order for us to achieve any kind of audible synchronization we need reasonably accurate clock synchronization across multiple devices.
The accuracy of the synchronization will also determine the degree to which we can manipulate playback to achieve psychoacoustic effects should we reach this milestone.
This section explores and evaluates the methods we have considered using.
%Why is sync of such importance?

An important distinction to make when discussing synchronization for our application is the difference between audible synchronization and clock synchronization.
This section focuses clock synchronization, the better clock synchronization we acquire the more accurate our playback manipulation becomes, and by extension our ability to create audible synchronization.
In that audible synchronization is the goal for the application, this also means that precision in the range of milliseconds is sufficient, furthermore one of our requirements mentioned in \cnameref{cha:requirement_elicitation} is to compete with the \ac{SOTA} applications.

%How can we achieve this synchronization
    %We propose and have looked into several methods
        %GPS
        %Audio
        %Light cues
        %Messages/Protocols(my time, adjust to this)
            %We looked into some academic research on this, however found that it was mostly unimplemented theories, often a bit off the mark from what we wanted to do.
        %NTP(external sync/offset calculations)
\section{Methods}
The following is a list of the possible solutions we have considered:
\begin{itemize}
    \item GPS
    \item Audio
    \item Light cues.
    \item Timestamps\mnote{Could expand this here already(NTP, PTP, GPS? may need to encapsulated here if not expandedd)}
\end{itemize}
An important thing to realize is also that if we were to synchronize the clocks, as in change the actual clock on the phones, they are required to be rooted for an application to do so.
While we placed \ac{UX} as a non-requirement, we can not expect users to root their device as, depending on country, it may violate copyright, warranty, and/or terms on service on the phone.
As such we will strictly speaking not be synchronizing the clocks, rather we will keep track of each devices offset to the source we want to synchronize with.

\subsubsection{GPS}
%https://spectracom.com/resources/essential-education/gps-clock-synchronization
GPS satellites contain multiple atomic clocks.
These clocks are monitored and controlled to keep them synchronized with the UTC standard.
This provides us with an accurate clock to synchronize towards.
After testing this, by developing an application to retrieve time from GPS, it was clear to us that the GPS hardware in our phones are limited to 1Hz updates and do not provide millisecond precision, which makes us unable to use GPS as a solution.

\subsubsection{Audio}\mnote{Can go into more detail about how we would solve the difficulties in this, but i do not think it is worth}
Another possible method is to use the audio to synchronize.
This would have every device attempt to synchronize based on their perception.
This method introduces several issues to be addressed, first of all there would be a ramp up time for the devices to figure out synchronization.
Furthermore adding more devices to the network introduces more complexity as each introduces a new audio source, and with each device figuring out their own synchronization it is unlikely that the devices are synchronization towards the same source.
While this may not have an effect on humans given only a few milliseconds of variance, due to psychoacoustic effects, it complicates the synchronization of the devices and our possible manipulation.

\subsubsection{Light Cues}
Alternatively we can use light rather than audio to synchronize.
This would also allow devices to respond as to achieve synchronization better.
The idea would be that a device uses the flashlight, once observed by another device it flashes back.
Using Einstein Synchronization we can use the respective times collected from this, to synchronize the two devices.
This has the significant disadvantage that the facing of the phones becomes important for synchronization, as the phones must have their flashes and cameras facing the synchronization target.
%https://en.wikipedia.org/wiki/Einstein_synchronisation

\subsubsection{\aclong{NTP}}
The last two options we are considering are to use existing protocols used for synchronization, one of which is \ac{NTP}.
\ac{NTP} works by using a hierarchical system with high--precision atomic clocks at the highest level, each level is then synchronized towards devices from the higher level.
\ac{NTP} polls multiple servers in the hierarchy and uses this to determine an actual time.
Essentially the \ac{NTP} servers we will be polling act like a clock master, as such even the master of the network will have an offset.
This also produces a hybrid solution between our proposed local centralized and remote centralized solutions, mentioned in \cnameref{sec:external_architectures}, by making the clock remote centralized, but maintaining all other control in a local network.
The idea here would be for each device to keep track of their own \ac{NTP} offset, and then have then play in accordance with the time acquired from \ac{NTP}. 

\subsubsection{\aclong{PTP}}
While \ac{NTP} requires internet to poll the \ac{NTP} hierarchy, \ac{PTP} is designed for LAN.
\ac{PTP} on the other hand uses the \ac{BMC} algorithm to determine a master and thereby disallowing us from making this decision.
If we are to use \ac{PTP} each device would keep track of their offset towards the master.
While \ac{PTP} has an expected accuracy in the nanoseconds, contrary to NTP's up to ten milliseconds, this is due to the LAN design.
This expected accuracy is also with a cable connection, with wireless, which we are using, it is not expected to have a precision in nanoseconds, rather the performance is expected to be similar to \ac{NTP}.

%What are the primary issues regarding synchronization.
    %msg delay
        %using offsets can help
%Perfect syncrhonization may actually cause problems, audible sync != clock sync

\section{Choice/Conclusion}
\ac{NTP} is both more mature and widespread protocol, furthermore we were also able to find examples of it being used on android whereas we could find no android apps using \ac{PTP}.
As such, for this solution we will be using \ac{NTP}.
%What way is "best"
%What seems feasable/which one are we attempting
    %audio may be possible, but complexity is very high
    %light cues arent feasable as it requires facing the phones properly
%could we merge/utilize elements from multiple ideas to acquire a superior form of synchronization
%This would solve "basic" synchronization milestone, how does it affect advanced synchronization milestone, are other solutions better for this? in that case why not start with those?